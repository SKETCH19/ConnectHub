trigger:
  branches:
    include:
    - Develop
    - QA
    - master

pool:
  vmImage: 'ubuntu-latest'  # Usamos Ubuntu que tiene mejor soporte para PHP

variables:
  phpVersion: '8.2'  # Ajusta según tu versión de PHP

steps:
# Paso 1: Configurar PHP
- script: |
    sudo apt-get update
    sudo apt-get install -y php php-xml php-mbstring php-curl
    php -v
  displayName: 'Instalar PHP y extensiones necesarias'

# Paso 2: Instalar Composer
- script: |
    curl -sS https://getcomposer.org/installer | php
    sudo mv composer.phar /usr/local/bin/composer
    composer --version
  displayName: 'Instalar Composer'

# Paso 3: Instalar dependencias del proyecto
- script: |
    composer install --no-progress --prefer-dist --optimize-autoloader
  displayName: 'Instalar dependencias con Composer'

# Paso 4: Ejecutar todas las pruebas unitarias
- script: |
    vendor/bin/phpunit --testsuite Unit --log-junit unit-test-results.xml
    vendor/bin/phpunit --testsuite Feature --log-junit feature-test-results.xml
  displayName: 'Ejecutar todas las pruebas PHPUnit'

# Paso 5: Publicar resultados de pruebas unitarias
- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/unit-test-results.xml'
    testRunTitle: 'Unit Test Results'
    mergeTestResults: true
  condition: succeededOrFailed()
  displayName: 'Publicar resultados de pruebas unitarias'

# Paso 6: Publicar resultados de pruebas de características
- task: PublishTestResults@2
  inputs:
    testResultsFiles: '**/feature-test-results.xml'
    testRunTitle: 'Feature Test Results'
    mergeTestResults: true
  condition: succeededOrFailed()
  displayName: 'Publicar resultados de pruebas de características'

# Paso 7: Publicar artefactos (opcional)
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(System.DefaultWorkingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
  condition: succeeded()
  displayName: 'Publicar artefactos'